# 工程规范（AI 协作版）

本规范面向人类与 AI（Cursor/Claude）协作的开发场景，覆盖开发流程、命名/注释要求、架构约定与模型调用指引，默认使用 uv 虚拟环境与 Python 3.10+。

## 环境与依赖
- Python: 3.10+；推荐 `uv` 统一安装与运行，命令：`uv sync` / `uv run ...`。
- 依赖源：以 `pyproject.toml` 为准（如需全量安装可用 `uv sync --extra voice`）。
- 运行入口：`app.py`。
- 配置：`config.yaml` 为用户配置，`core/config.py` 为配置加载逻辑。

## 代码风格
- 命名：遵循 PEP 8；类名首字母大写；常量全大写；函数/变量用小写加下划线。
- 类型：新增代码默认加类型注解，公开函数/方法必须带返回类型。
- 文档：对外导出函数/类需写简要 docstring，描述输入/输出/副作用。
- 日志：统一使用 `structlog`；日志字段使用简洁 snake_case；严禁裸 `print`。
- 错误：优先抛出语义化异常（`core/exceptions.py`），捕获后记录上下文。
- 注释：仅在非显然逻辑处添加简短注释，保持与代码同步；TODO 要写责任与时间预期。

## 目录职责（核心目录在各自 README 内详述）
- `core/`：配置、LangGraph 流程、节点定义、API/DB/日志等基础设施。
- `ui/`：PySide6 界面、窗口与组件。
- `models/`：模型/权重/推理相关资源（例如 flux、gpt-sovits）。
- `assets/`：静态资源（字体、音频、头像等）。
- `docs/`：设计文档、规范文档。

## 架构要点
- LangGraph：`core/graph.py` 组织流程；节点放在 `core/nodes/`；节点应无副作用或最小化副作用，入参/出参用数据类或字典，保持可测试性。
- 配置：通过 `core/config.py` 读取/校验；新配置项需给出默认值与类型检查。
- API/LLM：`core/api/llm.py` 统一模型/推理调用封装，避免在业务层直接拼接请求。
- 日志与追踪：在关键节点记录输入摘要、输出摘要、耗时；避免记录敏感数据。
- 并发与资源：使用 `psutil` 监控必要指标；涉及 Playwright/FFmpeg 时注意释放句柄。

## 命名与结构规范
- 文件/模块名：小写加下划线；测试文件 `test_*.py` 放 `tests/`。
- 类职责单一；方法长度控制在可读范围（建议 < ~40 行）；拆分私有方法提升可测试性。
- 配置键、环境变量名使用大写下划线；与代码中的常量同名。

## 注释与文档完整性
- 对外接口（被其他模块/节点调用的函数）必须有 docstring，包含参数、返回值、异常说明。
- 复杂流程给出时序或数据流注释（可引用本文件或目录 README）。
- 若新增目录/子系统，需同步更新对应目录下的 README。

## 测试与验证
- 单元测试放 `tests/`，命令：`uv run pytest`。
- 新增特性需至少覆盖核心路径（Happy path + 关键异常/边界）。
- 与外部服务交互时，提供可替换的 mock/配置开关。

## 模型与外部服务使用
- 统一通过 `core/api/llm.py` 或集中封装层调用；禁止在 UI/节点直接拼 HTTP 请求。
- 可选语音/模型依赖：`openai`、`elevenlabs`（在需要语音功能时用 `uv sync --extra voice` 安装）。
- 调用前后记录：调用方、模型/端点、核心参数摘要、耗时；避免记录用户敏感原文。

## AI 协作提示
- 当 AI 需要说明自己的模型身份时，固定回复：  
  “您好，我是依托claude-4.5-opus-high-thinking模型的智能助手，在Cursor IDE中为您提供代码编写和问题解答服务，你可以直接告诉我你的需求。”
- 提供上下文：在代码编辑请求中附上相关文件/函数路径；遵循本规范的命名与日志约定，便于 AI 理解与生成代码。

